name: Release Backend of PartGenie-MSIL

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SSH key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
        chmod 600 key.pem

    - name: Deploy to EC2 via Docker Compose
      run: |
        ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          cd $HOME/partsgenie-FE && git pull
          cd $HOME/partgenie-BE && git pull

          if [ ! -f "$HOME/partgenie-BE/.env" ]; then
            echo "❌ ERROR: Missing .env file in partgenie-BE!"
            exit 1
          fi

          cd $HOME
          docker-compose down
          docker-compose up --build -d
        EOF

